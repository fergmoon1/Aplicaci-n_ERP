{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block breadcrumb %}Dashboard{% endblock %}

{% block content %}
  <div class="container-fluid">
    <!-- Small boxes (Stat box) -->
    <div class="row">
      <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box bg-info">
          <div class="inner">
            <h3>{{ total_ventas | round(2) }}</h3>
            <p>Ventas del Mes</p>
          </div>
          <div class="icon">
            <i class="ion ion-bag"></i>
          </div>
        </div>
      </div>
      <!-- ./col -->
      <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box bg-success">
          <div class="inner">
            <h3>{{ pedidos_pendientes }}</h3>
            <p>Pedidos Pendientes</p>
          </div>
          <div class="icon">
            <i class="ion ion-stats-bars"></i>
          </div>
        </div>
      </div>
      <!-- ./col -->
      <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box bg-warning">
          <div class="inner">
            <h3>{{ alertas_stock }}</h3>
            <p>Alertas de Stock</p>
          </div>
          <div class="icon">
            <i class="ion ion-person-add"></i>
          </div>
        </div>
      </div>
      <!-- ./col -->
      <div class="col-lg-3 col-6">
        <!-- small box -->
        <div class="small-box bg-danger">
          <div class="inner">
            <h3>{{ clientes_nuevos }}</h3>
            <p>Clientes Nuevos</p>
          </div>
          <div class="icon">
            <i class="ion ion-pie-graph"></i>
          </div>
        </div>
      </div>
      <!-- ./col -->
    </div>
    <!-- /.row -->

    <!-- Secciones originales -->
    <div class="row">
      <!-- Productos más vendidos -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Productos Más Vendidos</h3>
          </div>
          <div class="card-body">
            <table class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Precio</th>
                  <th>Cantidad Vendida</th>
                  <th>Ingreso Total</th>
                </tr>
              </thead>
              <tbody>
                {% for producto in productos_mas_vendidos %}
                  <tr>
                    <td>{{ producto.nombre }}</td>
                    <td>{{ producto.precio | round(2) }}</td>
                    <td>{{ producto.total_vendido }}</td>
                    <td>{{ producto.ingreso_total | round(2) }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Pedidos por estado -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Pedidos por Estado</h3>
          </div>
          <div class="card-body">
            <ul class="list-group">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Pendiente
                <span class="badge bg-warning">{{ pedidos_por_estado.get('pendiente', 0) }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Completado
                <span class="badge bg-success">{{ pedidos_por_estado.get('completado', 0) }}</span>
              </li>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                Cancelado
                <span class="badge bg-danger">{{ pedidos_por_estado.get('cancelado', 0) }}</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Ingresos por mes -->
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Ingresos por Mes (Últimos 6 Meses)</h3>
          </div>
          <div class="card-body">
            <table class="table table-bordered table-striped">
              <thead>
                <tr>
                  <th>Mes</th>
                  <th>Ingreso Total</th>
                </tr>
              </thead>
              <tbody>
                {% for ingreso in ingresos_por_mes %}
                  <tr>
                    <td>{{ ingreso.mes }}</td>
                    <td>{{ ingreso.ingreso | round(2) }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Nuevas secciones con gráficos -->
    <div class="row">
      <!-- Gráfico de Ingresos por Mes -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Gráfico de Ingresos por Mes</h3>
          </div>
          <div class="card-body">
            <canvas id="ingresosPorMesChart" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Gráfico de Pedidos por Estado -->
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Gr##### Gráfico de Pedidos por Estado</h3>
          </div>
          <div class="card-body">
            <canvas id="pedidosPorEstadoChart" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráfico de Productos Más Vendidos -->
    <div class="row">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Gráfico de Productos Más Vendidos</h3>
          </div>
          <div class="card-body">
            <canvas id="productosMasVendidosChart" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts para los gráficos -->
  <script>
    // Datos para los gráficos (pasados desde Flask/Jinja)
    const ingresosPorMes = {{ ingresos_por_mes | tojson }};
    const pedidosPorEstado = {{ pedidos_por_estado | tojson }};
    const productosMasVendidos = {{ productos_mas_vendidos | tojson }};

    // Gráfico de Ingresos por Mes (Barras)
    const ctxIngresos = document.getElementById('ingresosPorMesChart').getContext('2d');
    new Chart(ctxIngresos, {
      type: 'bar',
      data: {
        labels: ingresosPorMes.map(item => item.mes),
        datasets: [{
          label: 'Ingreso Total',
          data: ingresosPorMes.map(item => item.ingreso),
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Ingresos'
            }
          },
          x: {
            title: {
              display: true,
              text: 'Mes'
            }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top'
          }
        }
      }
    });

    // Gráfico de Pedidos por Estado (Dona)
    const ctxPedidos = document.getElementById('pedidosPorEstadoChart').getContext('2d');
    new Chart(ctxPedidos, {
      type: 'doughnut',
      data: {
        labels: ['Pendiente', 'Completado', 'Cancelado'],
        datasets: [{
          data: [
            pedidosPorEstado.pendiente || 0,
            pedidosPorEstado.completado || 0,
            pedidosPorEstado.cancelado || 0
          ],
          backgroundColor: [
            'rgba(255, 206, 86, 0.6)', // Amarillo para Pendiente
            'rgba(75, 192, 192, 0.6)', // Verde para Completado
            'rgba(255, 99, 132, 0.6)'  // Rojo para Cancelado
          ],
          borderColor: [
            'rgba(255, 206, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(255, 99, 132, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        plugins: {
          legend: {
            position: 'top'
          }
        }
      }
    });

    // Gráfico de Productos Más Vendidos (Barras Horizontales)
    const ctxProductos = document.getElementById('productosMasVendidosChart').getContext('2d');
    new Chart(ctxProductos, {
      type: 'bar',
      data: {
        labels: productosMasVendidos.map(item => item.nombre),
        datasets: [{
          label: 'Cantidad Vendida',
          data: productosMasVendidos.map(item => item.total_vendido),
          backgroundColor: 'rgba(153, 102, 255, 0.6)',
          borderColor: 'rgba(153, 102, 255, 1)',
          borderWidth: 1
        }]
      },
      options: {
        indexAxis: 'y', // Esto hace que las barras sean horizontales
        scales: {
          x: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Cantidad Vendida'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Producto'
            }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top'
          }
        }
      }
    });
  </script>
{% endblock %}

